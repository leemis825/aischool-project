name: Deploy Backend to NCP Server

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout
        uses: actions/checkout@v3

      # 2) Naver Cloud Registry ë¡œê·¸ì¸
      - name: Login to Naver Cloud Registry
        run: |
          echo "${{ secrets.NCP_SECRET_KEY }}" | docker login \
            ${{ secrets.REGISTRY_URL }} \
            -u "${{ secrets.NCP_ACCESS_KEY }}" \
            --password-stdin

      # 3) ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      #    - Dockerfile.backend ê°€ ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ì— ìˆë‹¤ê³  ê°€ì •
      - name: Build Backend Docker image
        run: |
          docker build \
            -f Dockerfile.backend \
            -t ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME_BACKEND }}:latest .

      # 4) Registryë¡œ Push
      - name: Push Backend Docker image
        run: |
          docker push ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME_BACKEND }}:latest

      # 5) SSH í‚¤ ì„¤ì • (GitHub Runner â†’ NCP ì„œë²„)
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/minwon.pem
          chmod 600 ~/.ssh/minwon.pem

      # 6) ì„œë²„ ì ‘ì†í•´ì„œ ì»¨í…Œì´ë„ˆ êµì²´ + í—¬ìŠ¤ì²´í¬ + ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
      - name: Deploy to NCP Server
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/minwon.pem root@${{ secrets.SERVER_IP }} << 'EOF'
            set -e

            REGISTRY_URL="${REGISTRY_URL}"
            IMAGE_NAME_BACKEND="${IMAGE_NAME_BACKEND}"

            echo "==> í˜„ì¬ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë°±ì—…"
            OLD_IMAGE_ID=$(docker inspect --format='{{.Image}}' mk 2>/dev/null || true)

            echo "==> ìµœì‹  ë°±ì—”ë“œ ì´ë¯¸ì§€ pull"
            docker pull ${REGISTRY_URL}/${IMAGE_NAME_BACKEND}:latest

            echo "==> ê¸°ì¡´ ì»¨í…Œì´ë„ˆ mk ì¤‘ì§€/ì‚­ì œ"
            docker stop mk 2>/dev/null || true
            docker rm mk 2>/dev/null || true

            echo "==> ìƒˆ ì»¨í…Œì´ë„ˆ mk ì‹¤í–‰"
            docker run -d \
              --name mk \
              -p 8000:8000 \
              --restart unless-stopped \
              --env-file /home/ubuntu/minwon-kiosk/.env \
              ${REGISTRY_URL}/${IMAGE_NAME_BACKEND}:latest

            echo "==> í—¬ìŠ¤ì²´í¬ ì‹œì‘ (ìµœëŒ€ 10ë²ˆ, 5ì´ˆ ê°„ê²©)"
            success=false
            for i in $(seq 1 10); do
              sleep 5
              if curl -fs http://127.0.0.1:8000/ >/dev/null 2>&1; then
                echo "í—¬ìŠ¤ì²´í¬ í†µê³¼ âœ… (ì‹œë„ $i íšŒì°¨)"
                success=true
                break
              fi
              echo "í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„... ($i/10)"
            done

            if [ "$success" = false ]; then
              echo "í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ âŒ, ë¡¤ë°± ì§„í–‰"

              echo "==> ìƒˆ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 50ì¤„)"
              docker logs mk --tail=50 || true

              echo "==> ìƒˆ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì‚­ì œ"
              docker stop mk 2>/dev/null || true
              docker rm mk 2>/dev/null || true

              if [ -n "$OLD_IMAGE_ID" ]; then
                echo "==> ì´ì „ ì´ë¯¸ì§€ë¡œ ì»¨í…Œì´ë„ˆ ë³µêµ¬"
                docker run -d \
                  --name mk \
                  -p 8000:8000 \
                  --restart unless-stopped \
                  --env-file /home/ubuntu/minwon-kiosk/.env \
                  $OLD_IMAGE_ID
              else
                echo "ì´ì „ ì´ë¯¸ì§€ ì •ë³´ê°€ ì—†ì–´ ë¡¤ë°±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              fi

              # GitHub Actions ì— ì‹¤íŒ¨ í‘œì‹œ
              exit 1
            fi

            echo "ë°°í¬ & í—¬ìŠ¤ì²´í¬ ì™„ë£Œ ğŸ‰"
          EOF
      env:
        REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
        IMAGE_NAME_BACKEND: ${{ secrets.IMAGE_NAME_BACKEND }}

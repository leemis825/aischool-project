name: Deploy Backend to NCP Server

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1) GitHub에서 코드 가져오기
    - name: Checkout
      uses: actions/checkout@v3

    # 2) NCR 로그인
    - name: Login to Naver Cloud Registry
      run: |
        echo "${{ secrets.NCP_SECRET_KEY }}" | docker login \
          ${{ secrets.REGISTRY_URL }} \
          -u "${{ secrets.NCP_ACCESS_KEY }}" \
          --password-stdin

    # 3) Docker 이미지 빌드
    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME }}:latest .

    # 4) NCR로 이미지 push
    - name: Push Docker image
      run: |
        docker push ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME }}:latest

    # 5) SSH 키 설정
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/minwon.pem
        chmod 600 ~/.ssh/minwon.pem

    # 6) 서버에 접속해서 pull + 컨테이너 재시작
    - name: Deploy to NCP Server
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/minwon.pem root@${{ secrets.SERVER_IP }} << 'EOF'
          docker pull ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME }}:latest
          
          docker stop minwon || true
          docker rm minwon || true
          
          docker run -d \
            --name minwon \
            -p 8000:8000 \
            --restart unless-stopped \
            --env-file /home/ubuntu/minwon-kiosk/.env \
            ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME }}:latest
          docker logs minwon --tail=10
        EOF


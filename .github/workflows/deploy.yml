name: Deploy Backend & Frontend to NCP Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) 코드 가져오기
      - name: Checkout
        uses: actions/checkout@v3

      # 2) Naver Cloud Registry 로그인
      - name: Login to Naver Cloud Registry
        run: |
          echo "${{ secrets.NCP_SECRET_KEY }}" | docker login \
            ${{ secrets.REGISTRY_URL }} \
            -u "${{ secrets.NCP_ACCESS_KEY }}" \
            --password-stdin

      # 3-1) 백엔드 Docker 이미지 빌드
      - name: Build Backend Docker image
        run: |
          docker build \
            -f Dockerfile.backend \
            -t ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME_BACKEND }}:latest .

      # 3-2) 프론트엔드 Docker 이미지 빌드
      - name: Build Frontend Docker image
        run: |
          docker build \
            -f frontend/Dockerfile.frontend \
            -t ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME_FRONTEND }}:latest \
            ./frontend

      # 4-1) 백엔드 이미지 push
      - name: Push Backend Docker image
        run: |
          docker push ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME_BACKEND }}:latest

      # 4-2) 프론트엔드 이미지 push
      - name: Push Frontend Docker image
        run: |
          docker push ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME_FRONTEND }}:latest

      # 5) SSH 키 설정 (GitHub Runner → NCP 서버)
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/minwon.pem
          chmod 600 ~/.ssh/minwon.pem

      # 6) 서버 접속해서
      #    - 백엔드 컨테이너 교체 + 헬스체크 + 실패 시 롤백
      #    - 프론트엔드 컨테이너 교체 + 헬스체크 + 실패 시 롤백
      - name: Deploy to NCP Server (backend & frontend)
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/minwon.pem root@${{ secrets.SERVER_IP }} << 'EOF'
            set -e

            REGISTRY_URL="${REGISTRY_URL}"
            IMAGE_NAME_BACKEND="${IMAGE_NAME_BACKEND}"
            IMAGE_NAME_FRONTEND="${IMAGE_NAME_FRONTEND}"

            # (선택) 공용 네트워크 보장
            docker network create minwon-net 2>/dev/null || true

            ##############
            # 1) 백엔드 배포
            ##############
            echo "==> [BACKEND] 현재 컨테이너 이미지 백업"
            OLD_BACK_IMAGE_ID=$(docker inspect --format='{{.Image}}' mk 2>/dev/null || true)

            echo "==> [BACKEND] 최신 이미지 pull"
            docker pull ${REGISTRY_URL}/${IMAGE_NAME_BACKEND}:latest

            echo "==> [BACKEND] 기존 컨테이너 mk 중지/삭제"
            docker stop mk 2>/dev/null || true
            docker rm mk 2>/dev/null || true

            echo "==> [BACKEND] 새 컨테이너 mk 실행"
            docker run -d \
              --name mk \
              --network minwon-net \
              -p 8000:8000 \
              --restart unless-stopped \
              --env-file /home/ubuntu/minwon-kiosk/.env \
              ${REGISTRY_URL}/${IMAGE_NAME_BACKEND}:latest

            echo "==> [BACKEND] 헬스체크 시작 (최대 10번, 5초 간격)"
            backend_ok=false
            for i in $(seq 1 10); do
              sleep 5
              if curl -fs http://127.0.0.1:8000/ >/dev/null 2>&1; then
                echo "[BACKEND] 헬스체크 통과 (시도 $i 회차)"
                backend_ok=true
                break
              fi
              echo "[BACKEND] 헬스체크 재시도... ($i/10)"
            done

            if [ "$backend_ok" = false ]; then
              echo "[BACKEND] 헬스체크 실패, 롤백 진행"

              echo "==> [BACKEND] 새 컨테이너 로그 (최근 50줄)"
              docker logs mk --tail=50 || true

              echo "==> [BACKEND] 새 컨테이너 종료 및 삭제"
              docker stop mk 2>/dev/null || true
              docker rm mk 2>/dev/null || true

              if [ -n "$OLD_BACK_IMAGE_ID" ]; then
                echo "==> [BACKEND] 이전 이미지로 컨테이너 복구"
                docker run -d \
                  --name mk \
                  --network minwon-net \
                  -p 8000:8000 \
                  --restart unless-stopped \
                  --env-file /home/ubuntu/minwon-kiosk/.env \
                  $OLD_BACK_IMAGE_ID
              else
                echo "[BACKEND] 이전 이미지 정보가 없어 롤백할 수 없습니다."
              fi

              exit 1
            fi

            echo "==> [BACKEND] 배포 & 헬스체크 완료"

            ##############
            # 2) 프론트엔드 배포
            ##############
            echo "==> [FRONT] 현재 컨테이너 이미지 백업"
            OLD_FRONT_IMAGE_ID=$(docker inspect --format='{{.Image}}' mk-front 2>/dev/null || true)

            echo "==> [FRONT] 최신 이미지 pull"
            docker pull ${REGISTRY_URL}/${IMAGE_NAME_FRONTEND}:latest

            echo "==> [FRONT] 기존 컨테이너 mk-front 중지/삭제"
            docker stop mk-front 2>/dev/null || true
            docker rm mk-front 2>/dev/null || true

            echo "==> [FRONT] 새 컨테이너 mk-front 실행"
            docker run -d \
              --name mk-front \
              --network minwon-net \
              -p 80:80 \
              --restart unless-stopped \
              ${REGISTRY_URL}/${IMAGE_NAME_FRONTEND}:latest

            echo "==> [FRONT] 헬스체크 시작 (최대 10번, 5초 간격)"
            front_ok=false
            for i in $(seq 1 10); do
              sleep 5
              if curl -fs http://127.0.0.1/ >/dev/null 2>&1; then
                echo "[FRONT] 헬스체크 통과 (시도 $i 회차)"
                front_ok=true
                break
              fi
              echo "[FRONT] 헬스체크 재시도... ($i/10)"
            done

            if [ "$front_ok" = false ]; then
              echo "[FRONT] 헬스체크 실패, 롤백 진행"

              echo "==> [FRONT] 새 컨테이너 로그 (최근 50줄)"
              docker logs mk-front --tail=50 || true

              echo "==> [FRONT] 새 컨테이너 종료 및 삭제"
              docker stop mk-front 2>/dev/null || true
              docker rm mk-front 2>/dev/null || true

              if [ -n "$OLD_FRONT_IMAGE_ID" ]; then
                echo "==> [FRONT] 이전 이미지로 컨테이너 복구"
                docker run -d \
                  --name mk-front \
                  --network minwon-net \
                  -p 80:80 \
                  --restart unless-stopped \
                  $OLD_FRONT_IMAGE_ID
              else
                echo "[FRONT] 이전 이미지 정보가 없어 롤백할 수 없습니다."
              fi

              exit 1
            fi

            echo "==> [FRONT] 배포 & 헬스체크 완료"
            echo "==> 전체 배포 완료"

            echo "==> 오래된 Docker 리소스 자동 정리 (최근 7일 이전 것 삭제)"
            docker system prune -af --filter "until=168h" || true
          EOF
        env:
          REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
          IMAGE_NAME_BACKEND: ${{ secrets.IMAGE_NAME_BACKEND }}
          IMAGE_NAME_FRONTEND: ${{ secrets.IMAGE_NAME_FRONTEND }}
